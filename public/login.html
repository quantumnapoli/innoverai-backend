<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>INNOVERAI - Accesso Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-1L2Y0GVP80"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-1L2Y0GVP80');
    </script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .glass-effect {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
    </style>
</head>
<body class="gradient-bg min-h-screen flex items-center justify-center">
    <!-- Carica configurazione -->
    <script src="../.config.js"></script>
    
    <div class="w-full max-w-md px-6">
        <div class="glass-effect rounded-2xl shadow-2xl p-8">
            <!-- Logo e Header -->
            <div class="text-center mb-8">
                <img src="../assets/logowhite-tr.webp" alt="INNOVERAI" class="h-16 mx-auto mb-4 opacity-95" />
                <h1 class="text-2xl font-bold text-white mb-2">Dashboard AI</h1>
                <p class="text-blue-100 text-sm">Sistema di Monitoraggio Vocale</p>
            </div>

            <!-- Form di Login -->
            <form id="loginForm" onsubmit="handleLogin(event)" class="space-y-6">
                <!-- Messaggio di Errore -->
                <div id="error-message" class="hidden bg-red-500 bg-opacity-20 border border-red-400 text-red-100 px-4 py-3 rounded-lg">
                    <i class="fas fa-exclamation-triangle mr-2"></i>
                    <span id="error-text">Credenziali non valide</span>
                </div>

                <div>
                    <label for="username" class="block text-sm font-medium text-blue-100 mb-2">
                        <i class="fas fa-user mr-2"></i>Username
                    </label>
                    <input 
                        type="text" 
                        id="username" 
                        name="username" 
                        required 
                        value="demo"
                        class="w-full px-3 py-2 bg-white bg-opacity-20 border border-white border-opacity-30 rounded-lg text-white placeholder-blue-200 focus:outline-none focus:ring-2 focus:ring-blue-300 focus:bg-opacity-30"
                        placeholder="Inserisci username"
                    />
                </div>

                <div>
                    <label for="password" class="block text-sm font-medium text-blue-100 mb-2">
                        <i class="fas fa-lock mr-2"></i>Password
                    </label>
                    <input 
                        type="password" 
                        id="password" 
                        name="password" 
                        required 
                        value="demo"
                        class="w-full px-3 py-2 bg-white bg-opacity-20 border border-white border-opacity-30 rounded-lg text-white placeholder-blue-200 focus:outline-none focus:ring-2 focus:ring-blue-300 focus:bg-opacity-30"
                        placeholder="Inserisci password"
                    />
                </div>

                <button 
                    type="submit" 
                    class="w-full flex justify-center py-2 px-4 border border-transparent rounded-lg shadow-sm text-sm font-medium text-blue-600 bg-white hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-all duration-200"
                >
                    <i class="fas fa-sign-in-alt mr-2"></i>
                    Accedi alla Dashboard
                </button>
            </form>

            <!-- Info Demo -->
            <div class="mt-6 p-4 bg-green-500 bg-opacity-20 rounded-lg">
                <p class="text-sm text-green-100 text-center">
                    <i class="fas fa-play-circle mr-1"></i>
                    Modalit√† Demo - Dati di esempio precaricati
                </p>
            </div>
        </div>

        <!-- Footer -->
        <div class="text-center mt-6">
            <p class="text-blue-200 text-sm">
                ¬© 2024 INNOVERAI - Sistema AI Vocale
            </p>
        </div>
    </div>

    <script>
        // Backend API endpoint - dynamically determine based on environment
        function getLoginAPIUrl() {
            // Local development
            if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
                return 'http://localhost:8080';
            }
            // Production: use backend Railway URL (not landing page)
            return 'https://innoverai-backend-production.up.railway.app';
        }
        const API_BASE_URL = getLoginAPIUrl();

        // Fallback credentials for local dev (if backend not available)
        const VALID_CREDENTIALS = window.AUTH_CONFIG ? window.AUTH_CONFIG.USERS : {
            'demo': { password: 'demo', role: 'demo', name: 'Utente Demo' },
            'admin': { password: 'jament78#@', role: 'admin', name: 'Admin' },
            'marco': { password: 'esposito2025', role: 'client', name: 'Marco Esposito', agent_id: 'agent_0c73985e38f6110dbec24596c1' }
        };

        async function handleLogin(event) {
            event.preventDefault();
            
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const errorDiv = document.getElementById('error-message');
            const errorText = document.getElementById('error-text');
            const submitBtn = event.target.querySelector('button[type="submit"]');
            
            // Disable button during login
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Accesso...';
            
            try {
                // Try backend login first
                const response = await fetch(`${API_BASE_URL}/api/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ username, password })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    
                    // Save session with JWT token
                    const sessionKey = window.AUTH_CONFIG ? window.AUTH_CONFIG.SESSION.KEY : 'innoverAISession';
                    localStorage.setItem(sessionKey, JSON.stringify({
                        username: data.username,
                        role: data.role,
                        name: data.name,
                        agent_id: data.agent_id,
                        token: data.token,
                        loginTime: Date.now(),
                        expires: Date.now() + (12 * 60 * 60 * 1000) // 12h
                    }));
                    
                    console.log('‚úÖ Login successful via backend for:', data.name);
                    
                    // Redirect to dashboard
                    window.location.href = 'index.html';
                    return;
                }
                
                // Backend returned error
                throw new Error('Invalid credentials');
                
            } catch (error) {
                console.warn('‚ö†Ô∏è Backend login failed, trying local fallback:', error.message);
                
                // Fallback to local credentials
                const user = VALID_CREDENTIALS[username];
                if (user && user.password === password) {
                    // Login riuscito (fallback locale)
                    const sessionKey = window.AUTH_CONFIG ? window.AUTH_CONFIG.SESSION.KEY : 'innoverAISession';
                    const sessionDuration = window.AUTH_CONFIG ? window.AUTH_CONFIG.SESSION.DURATION : (24 * 60 * 60 * 1000);
                    
                    localStorage.setItem(sessionKey, JSON.stringify({
                        username: username,
                        role: user.role,
                        name: user.name,
                        agent_id: user.agent_id,
                        loginTime: Date.now(),
                        expires: Date.now() + sessionDuration
                    }));
                    
                    console.log('‚úÖ Login successful via local fallback for:', user.name);
                    
                    // Reindirizza alla dashboard
                    window.location.href = 'index.html';
                } else {
                    // Mostra errore
                    errorText.textContent = 'Credenziali non valide';
                    errorDiv.classList.remove('hidden');
                    
                    // Nascondi errore dopo 3 secondi
                    setTimeout(() => {
                        errorDiv.classList.add('hidden');
                    }, 3000);
                    
                    // Reset password field
                    document.getElementById('password').value = '';
                    
                    // Re-enable button
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = '<i class="fas fa-sign-in-alt mr-2"></i>Accedi alla Dashboard';
                }
            }
        }

        // DISABILITATO AUTO-LOGIN - l'utente deve sempre fare login manualmente
        window.addEventListener('load', function() {
            // Pulisci SEMPRE tutte le sessioni al caricamento della pagina di login
            console.log('üßπ Pulizia automatica sessioni al caricamento login page');
            
            try {
                localStorage.clear();
                sessionStorage.clear();
                console.log('‚úÖ Tutte le sessioni cancellate');
            } catch(e) {
                console.error('‚ùå Errore pulizia:', e);
            }
        });

        // Focus automatico sul campo username se vuoto
        window.addEventListener('load', function() {
            const usernameField = document.getElementById('username');
            if (!usernameField.value) {
                usernameField.focus();
            }
        });
    </script>
</body>
</html>